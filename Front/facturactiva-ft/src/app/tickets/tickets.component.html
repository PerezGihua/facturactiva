<div class="main-container">
  <!-- Barra superior -->
  <header class="header">
    <div class="logo-section">
      <img src="/logo-facturactiva.png" alt="Logo Facturactiva" class="logo" />
    </div>

    <div class="search-section">
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input 
          type="text" 
          placeholder="Buscar en Factur&#64;ctiva"
          [(ngModel)]="searchTerm"
          (input)="filtrarTickets()"
        />
      </div>
    </div>

    <div class="user-section">
      <div class="user-info" *ngIf="currentUser$ | async as user">
        <div class="user-text">
          <span class="user-name">{{ utils.getShortName(user.nombreCompleto) }}</span>
          <span class="user-role">{{ utils.getRolName(user.idRol) }}</span>
        </div>

        <div class="user-avatar">
          <i class="fa-solid fa-user"></i>
        </div>
      </div>
    </div>
  </header>

  <div class="content">

    <!-- Menú lateral -->
    <aside class="sidebar">
      <div class="sidebar-title">PRINCIPAL</div>

      <ul>
        <li
          routerLink="/inicio"
          routerLinkActive="active"
          [routerLinkActiveOptions]="{ exact: true }"
        >
          <i class="fa-solid fa-house"></i> Inicio
        </li>

        <li
          routerLink="/tickets"
          routerLinkActive="active"
          [routerLinkActiveOptions]="{ exact: false }"
        >
          <i class="fa-solid fa-ticket"></i> Ticket
        </li>
      </ul>

      <div class="bottom" (click)="logout()">
        <i class="fa-solid fa-right-from-bracket"></i> Salir
      </div>
    </aside>

    <!-- Área central -->
    <main class="main-content">
      <div class="tickets-container">

        <div class="tickets-header">
          <h2>Mis Tickets</h2>

          <!-- BOTÓN CREAR - SOLO PARA CLIENTES -->
          <button *ngIf="idRol === '1'" class="create-btn" routerLink="crear">
            Crear +
          </button>
        </div>

        <!-- TABLA DE TICKETS -->
        <div class="table-container">
          <!-- Spinner mientras carga -->
          <div *ngIf="isLoadingTickets" class="tickets-loading" style="text-align:center; padding:40px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size:24px;"></i>
            <div style="margin-top:10px; color:#666;">Cargando tickets...</div>
          </div>

          <!-- Mensaje de error al cargar -->
          <div *ngIf="!isLoadingTickets && loadErrorMessage" class="tickets-error" style="text-align:center; padding:20px; color:#c0392b;">
            <div>{{ loadErrorMessage }}</div>
            <button class="create-btn" (click)="loadMyTickets()" style="margin-top:10px;">Reintentar</button>
          </div>

          <!-- Tabla cuando no hay carga ni error -->
          <table *ngIf="!isLoadingTickets && !loadErrorMessage" class="tickets-table">
            <thead>
              <tr>
                <th>Código</th>
                <th>Asunto</th>
                <th>Descripción</th>
                <th>Documento</th>
                <th>Fecha Creación</th>
                <th>Estado</th>
              </tr>
            </thead>

            <tbody>
              <!-- Mensaje si no hay resultados -->
              <tr *ngIf="tickets.length === 0">
                <td colspan="6" style="text-align: center; padding: 30px; color: #999;">
                  No se encontraron tickets que coincidan con "{{ searchTerm }}"
                </td>
              </tr>

              <!-- Lista de tickets filtrados -->
              <tr *ngFor="let ticket of tickets" class="ticket-row">
                <!-- Las celdas normales abren el editor al hacer click -->
                <td (click)="editarTicket(ticket.codigo)">
                  <div class="codigo-cell">
                    <i class="fa-solid {{ ticket.tipoIcono }} icon-documento" [style.color]="getIconColor(ticket.tipoComprobante)"></i>
                    <span>{{ ticket.codigo }}</span>
                  </div>
                </td>

                <td (click)="editarTicket(ticket.codigo)">{{ ticket.asunto }}</td>
                <td class="descripcion-cell" (click)="editarTicket(ticket.codigo)">{{ ticket.descripcion }}</td>
                <td (click)="editarTicket(ticket.codigo)">{{ ticket.numDocRechazado || '-' }}</td>
                <td (click)="editarTicket(ticket.codigo)">{{ ticket.fechaCreacion }}</td>

                <td (click)="editarTicket(ticket.codigo)">
                  <span
                    class="estado-badge"
                    [ngClass]="getEstadoClass(ticket.estado)"
                  >
                    <i class="fa-solid fa-circle"></i>
                    {{ ticket.estado }}
                  </span>
                </td>

                <!-- <td>
                  <div class="actions">
                    <button
                      *ngIf="idRol === '1'"
                      class="btn-action btn-delete"
                      (click)="eliminarTicket(ticket.codigo); $event.stopPropagation()"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                </td> -->
              </tr>
            </tbody>
          </table>
        </div>

      </div>

      <div
        class="overlay"
        *ngIf="router.url.includes('/tickets/crear') || router.url.includes('/tickets/editar')"
        (click)="cerrarPanel()"
      ></div>

      <!-- PANEL DERECHO -->
      <router-outlet></router-outlet>

    </main>

  </div>

  <!-- MODAL DE CONFIRMACIÓN/ALERTA -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalConfig.title }}</h3>
        <button class="modal-close" (click)="closeModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="modal-body">
        <p>{{ modalConfig.message }}</p>
      </div>

      <div class="modal-footer">
        <button
          *ngIf="modalConfig.type === 'confirm'"
          class="modal-btn modal-btn-cancel"
          (click)="modalConfig.onCancel()"
        >
          Cancelar
        </button>
        <button
          class="modal-btn modal-btn-confirm"
          (click)="modalConfig.onConfirm()"
        >
          {{ modalConfig.type === 'confirm' ? 'Aceptar' : 'OK' }}
        </button>
      </div>
    </div>
  </div>

</div>

<app-modalticket
  *ngIf="mostrarModalAgente"
  [ticketCodigo]="codigoTicketSeleccionado"
  [ticketData]="getTicketByCodigo(codigoTicketSeleccionado)"
  [userRole]="userRole"
  [idRol]="idRol"
  (cerrarModal)="cerrarModalAgente()"
  (ticketActualizado)="loadMyTickets()"
></app-modalticket>
