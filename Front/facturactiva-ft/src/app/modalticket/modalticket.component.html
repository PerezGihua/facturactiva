<div class="modal-overlay" (click)="cerrar()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    
    <!-- Header del Modal -->
    <div class="modal-header">
      <h2><i class="fa-solid fa-ticket"></i> {{ ticket?.codigo }}</h2>
      <button class="btn-close" (click)="cerrar()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- Contenido del Modal -->
    <div class="modal-body" *ngIf="ticket">
      
      <!-- Información del Ticket en 2 columnas -->
      <div class="ticket-info-grid">
        
        <!-- Columna Izquierda -->
        <div class="info-column">
          <!-- Asunto - Editable para clientes -->
          <div *ngIf="puedeEditarCampos">
            <label class="label-editable">ASUNTO</label>
            <input 
              type="text" 
              [(ngModel)]="asuntoEditable" 
              class="input-editable"
              placeholder="Ingrese el asunto"
            />
          </div>
          <p *ngIf="!puedeEditarCampos" class="asunto-texto">{{ ticket.asunto }}</p>

          <!-- N° Documento - Editable para clientes -->
          <div class="info-item num-documento">
            <label>N° Documento:</label>
            <input 
              *ngIf="puedeEditarCampos"
              type="text" 
              [(ngModel)]="numDocumentoEditable" 
              class="input-inline-editable"
              placeholder="Número de documento"
            />
            <span *ngIf="!puedeEditarCampos">{{ ticket.numDocRechazado }}</span>
          </div>

          <!-- Descripción - Editable para clientes -->
          <div class="info-item">
            <label>Descripción:</label>
            <textarea 
              *ngIf="puedeEditarCampos"
              [(ngModel)]="descripcionEditable" 
              class="textarea-editable"
              rows="4"
              placeholder="Describa el problema"
            ></textarea>
            <p *ngIf="!puedeEditarCampos" class="descripcion-texto">{{ ticket.descripcion }}</p>
          </div>

          <!-- Botón Guardar Cambios - Solo para clientes -->
          <button 
            *ngIf="puedeEditarCampos" 
            class="btn-guardar-cambios"
            (click)="guardarCambios()"
            [disabled]="isSaving"
          >
            <i class="fa-solid fa-save"></i>
            {{ isSaving ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>

        <!-- Columna Derecha -->
        <div class="info-column">
          <div class="info-item">
            <label>Fecha de creación:</label>
            <span>{{ ticket.fechaCreacion }}</span>
          </div>

          <div class="info-item">
            <label>Estado:</label>
            <!-- Solo agentes pueden cambiar el estado -->
            <select 
              *ngIf="puedeEditarEstado"
              [(ngModel)]="ticket.estado" 
              (change)="cambiarEstado(ticket.estado)"
              [ngClass]="getEstadoClass(ticket.estado)"
              class="estado-select"
            >
              <option *ngFor="let estado of estadosDisponibles" [value]="estado">
                {{ estado }}
              </option>
            </select>
            <!-- Clientes solo ven el estado, no pueden cambiarlo -->
            <span 
              *ngIf="!puedeEditarEstado"
              class="estado-badge"
              [ngClass]="getEstadoClass(ticket.estado)"
            >
              <i class="fa-solid fa-circle"></i>
              {{ ticket.estado }}
            </span>
          </div>

          <div class="info-item">
            <label>Documentos Adjuntos:</label>
            <div class="documento-preview">
              <i class="fa-solid fa-file-image"></i>
              <span>(IMAGEN DEL DOCUMENTO)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Separador -->
      <hr class="separador">

      <!-- Sección de Comentarios -->
      <div class="comentarios-section">
        <h3>
          <i class="fa-solid fa-comments"></i> Comentarios
        </h3>

        <!-- Lista de comentarios -->
        <div class="comentarios-lista">
          <div *ngFor="let comentario of comentarios" class="comentario-item">
            
            <!-- Comentario principal -->
            <div class="comentario-content" [ngClass]="'comentario-' + comentario.rol">
              <div class="comentario-header">
                <div class="autor-info">
                  <i class="fa-solid fa-user-circle"></i>
                  <strong>{{ comentario.autor }}</strong>
                  <span class="rol-badge" [ngClass]="comentario.rol">
                    {{ comentario.rol === 'agente' ? 'Agente' : 'Cliente' }}
                  </span>
                </div>
                <span class="fecha">{{ comentario.fecha }}</span>
              </div>
              <p class="comentario-texto">{{ comentario.texto }}</p>
              
              <!-- Botón para responder -->
              <button class="btn-responder" (click)="toggleRespuestas(comentario.id)">
                <i class="fa-solid fa-reply"></i> Responder
              </button>
            </div>

            <!-- Área de respuesta -->
            <div *ngIf="mostrarRespuestas[comentario.id]" class="respuesta-input">
              <textarea 
                [(ngModel)]="respuestaTexto[comentario.id]"
                placeholder="Escribe tu respuesta..."
                rows="2"
              ></textarea>
              <button class="btn-enviar-respuesta" (click)="agregarRespuesta(comentario.id)">
                <i class="fa-solid fa-paper-plane"></i> Enviar
              </button>
            </div>

            <!-- Respuestas anidadas -->
            <div *ngIf="comentario.respuestas.length > 0" class="respuestas-lista">
              <div *ngFor="let respuesta of comentario.respuestas" class="comentario-item respuesta">
                <div class="flecha-respuesta">
                  <i class="fa-solid fa-turn-up fa-rotate-90"></i>
                </div>
                <div class="comentario-content" [ngClass]="'comentario-' + respuesta.rol">
                  <div class="comentario-header">
                    <div class="autor-info">
                      <i class="fa-solid fa-user-circle"></i>
                      <strong>{{ respuesta.autor }}</strong>
                      <span class="rol-badge" [ngClass]="respuesta.rol">
                        {{ respuesta.rol === 'agente' ? 'Agente' : 'Cliente' }}
                      </span>
                    </div>
                    <span class="fecha">{{ respuesta.fecha }}</span>
                  </div>
                  <p class="comentario-texto">{{ respuesta.texto }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Input para nuevo comentario -->
        <div class="nuevo-comentario">
          <textarea 
            [(ngModel)]="nuevoComentario"
            placeholder="Escribe un comentario..."
            rows="3"
          ></textarea>
          <div class="comentario-actions">
            <!-- Botón Eliminar - Solo para clientes -->
            <button 
              *ngIf="idRol === '1'" 
              class="btn-eliminar-ticket" 
              (click)="eliminarTicket()"
            >
              <i class="fa-solid fa-trash"></i> Eliminar
            </button>
            <button class="btn-agregar-comentario" (click)="agregarComentario()">
              <i class="fa-solid fa-paper-plane"></i> Agregar Comentario
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACIÓN -->
<div class="confirmation-overlay" *ngIf="mostrarConfirmacion" (click)="cancelarAccion()">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <div class="confirmation-icon" [ngClass]="tipoConfirmacion === 'eliminar' ? 'icon-eliminar' : 'icon-guardar'">
      <i class="fa-solid" [ngClass]="tipoConfirmacion === 'eliminar' ? 'fa-triangle-exclamation' : 'fa-circle-question'"></i>
    </div>
    <h3>{{ tituloConfirmacion }}</h3>
    <p>{{ mensajeConfirmacion }}</p>
    <div class="confirmation-buttons">
      <button class="btn-cancelar" (click)="cancelarAccion()">
        <i class="fa-solid fa-xmark"></i> No
      </button>
      <button class="btn-confirmar" [ngClass]="tipoConfirmacion === 'eliminar' ? 'btn-eliminar-confirm' : 'btn-guardar-confirm'" (click)="confirmarAccion()">
        <i class="fa-solid fa-check"></i> Sí
      </button>
    </div>
  </div>
</div>